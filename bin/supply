#!/usr/bin/env bash

# Absolute path
BIN_DIR=$(cd $(dirname $0) && pwd)

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
INDEX=$4

source ${BIN_DIR}/../vars.sh

echo "-----> Installing java"
wget --no-check-certificate -q -c \
        --header "Cookie: oraclelicense=accept-securebackup-cookie" \
        ${JRE_URL} -O ${BIN_DIR}/jre.zip

mkdir ${BUILD_DIR}/.java

# Unpack jre content directly to .java in BUILD_DIR
# -C is the directory, strip-components removes the top-level folder (jre_1.8.....)
tar zxf ${BIN_DIR}/jre.zip -C ${BUILD_DIR}/.java --strip-components 1

echo "-----> Installing sonarqube"
if [ -z ${SONARQUBE_VERSION+x} ];
then
    echo "SONARQUBE_VERSION is not set. Add it to your manifest.yml file (i.e. SONARQUBE_VERSION: \"7.1\") to fix this error."
    exit 1
fi

wget "$SONARQUBE_DIST_URL/sonarqube/$SONARQUBE_ZIP" -O ${BIN_DIR}/sonarqube.zip --no-check-certificate -q
unzip -q ${BIN_DIR}/sonarqube.zip -d ${BUILD_DIR}
mv ${BUILD_DIR}/sonarqube-* ${BUILD_DIR}/sonarqube # Remove version suffix"


if [[ -f ${BUILD_DIR}/sonar-plugins.yml ]]; then
    echo "-----> Installing plugins"

    cat ${BUILD_DIR}/sonar-plugins.yml | while read line
    do
        IFS=': ' read -r -a array <<< "$line"
        PLUGIN_NAME=${array[0]}
        PLUGIN_VERSION=${array[1]}
        PLUGIN_URL="$SONARQUBE_DIST_URL/${PLUGIN_NAME}/${PLUGIN_NAME}-${PLUGIN_VERSION}.jar"
        echo "       Installing ${PLUGIN_NAME} (${PLUGIN_VERSION})"
        wget ${PLUGIN_URL} -O "${BUILD_DIR}/sonarqube/extensions/plugins/${PLUGIN_NAME}-${PLUGIN_VERSION}.jar" --no-check-certificate -q
    done
fi
